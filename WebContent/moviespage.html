<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movies Page</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="css/moviepage.css">
</head>

<body>

    <div class="container mt-5">
        <h1 class="text-center mb-5">Movies Page</h1>

        <!-- Sorting options -->
        <div class="row mb-3">
            <div class="col-md-12">
                <label for="sort_option">Sort by:</label>
                <select class="form-control" id="sort_option">
                    <option value="title_asc_rating_desc">Title (Increasing) - Rating (Decreasing)</option>
                    <option value="title_asc_rating_asc">Title (Increasing) - Rating (Increasing)</option>
                    <option value="title_desc_rating_desc">Title (Decreasing) - Rating (Decreasing)</option>
                    <option value="title_desc_rating_asc">Title (Decreasing) - Rating (Increasing)</option>
                    <option value="rating_asc_title_desc">Rating (Increasing) - Title (Decreasing)</option>
                    <option value="rating_asc_title_asc">Rating (Increasing) - Title (Increasing)</option>
                    <option value="rating_desc_title_desc">Rating (Decreasing) - Title (Decreasing)</option>
                    <option value="rating_desc_title_asc">Rating (Decreasing) - Title (Increasing)</option>
                </select>
            </div>
        </div>

        <!-- Pagination controls -->
        <div class="row mb-3">
            <div class="col-md-6">
                <label for="page_size">Movies per Page:</label>
                <select class="form-control" id="page_size">
                    <option value="10">10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
            <div class="col-md-6 text-right">
                <button class="btn btn-primary" id="prev_btn">Previous</button>
                <button class="btn btn-primary ml-2" id="next_btn">Next</button>
            </div>
            <!--            <div class="col-md-12">-->
            <!--                <button id="backToMovieListBtn" class="btn btn-secondary" disabled>Back to Movie List</button>-->
            <!--            </div>-->
            <div class="container mt-3">
                <a href="shoppingcart.html" class="btn btn-primary">View Cart</a>
            </div>

        </div>

        <div class="row" id="genreMovies">
            <!-- Genre cards will be dynamically added here -->
            <button class="btn btn-primary add-to-cart-btn" data-movie-id="movie_id_here">Add to Cart</button>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>



    <script>
        $(document).ready(function () {
            // Event listener for Add to Cart button clicks
            $(document).on('click', '.add-to-cart-btn', function () {
                var movieId = $(this).data('movie-id');
                var movieTitle = $(this).data('movie-title'); // Retrieve movie title from data attribute
                addToCart(movieId, movieTitle);
            });

            // Function to add movie to the cart
            function addToCart(movieId, movieTitle) {
                console.log('Adding movie to cart:', movieId, movieTitle); // Debug statement
                $.ajax({
                    url: 'addToCart',
                    method: 'POST',
                    data: {
                        movieId: movieId,
                        movieTitle: movieTitle // Pass movieTitle as a parameter in the AJAX request
                    },
                    dataType: 'json',
                    success: function (response) {
                        console.log('Add to cart success:', response); // Debug statement
                        alert('Movie added to cart successfully!');
                    },
                    error: function (xhr, status, error) {
                        console.error('Add to cart error:', status, error); // Debug statement
                        alert('Failed to add movie to cart. Please try again later.');
                    }
                });
            }

        });

        // Check URL parameters and load specific scripts
        $(document).ready(function () {
            // Function to get URL parameters
            function getUrlParameter(name) {
                name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
                var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
                var results = regex.exec(location.search);
                return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
            }

            // Load script based on URL parameters
            var titleParam = getUrlParameter('title');
            var directorParam = getUrlParameter('director');
            var yearParam = getUrlParameter('year');
            var starParam = getUrlParameter('star');
            var idParam = getUrlParameter('id');
            var characParam = getUrlParameter('charac');

            if (titleParam !== '' || directorParam !== '' || yearParam !== '' || starParam !== '') {
                // Script for title parameter
                $(document).ready(function () {
                    var pageNumber = 1; // Initialize page number
                    var pageSize = 10; // Default page size

                    // Function to fetch search results with sorting and pagination parameters
                    function fetchSearchResults() {
                        var title = getUrlParameter('title');
                        var director = getUrlParameter('director');
                        var year = getUrlParameter('year');
                        var star = getUrlParameter('star');
                        var sortOption = $('#sort_option').val();

                        $.ajax({
                            url: 'searchresults',
                            method: 'GET',
                            data: {
                                title: title,
                                director: director,
                                year: year,
                                star: star,
                                sort_option: sortOption,
                                pageSize: pageSize,
                                pageNumber: pageNumber
                            },
                            dataType: 'json',
                            success: function (searchResults) {
                                displaySearchResults(searchResults);
                            },
                            error: function (xhr, status, error) {
                                console.error('Error fetching search results:', status, error);
                                alert('Failed to fetch search results. Please try again later.');
                            }
                        });
                    }

                    // Function to display search results as cards
                    function displaySearchResults(searchResults) {
                        var searchResultsContainer = $('#genreMovies');
                        searchResultsContainer.empty(); // Clear existing search results

                        if (searchResults.length === 0) {
                            searchResultsContainer.html("<p class='col-12 text-muted'>No results found.</p>");
                        } else {
                            $.each(searchResults, function (index, result) {
                                var card = $("<div class='col-md-4 mb-4'>");
                                var cardBody = $("<div class='card'>");
                                var cardContent = $("<div class='card-body'>");
                                var titleLink = $('<a>').attr('href', 'singlemoviepage.html?id=' + encodeURIComponent(result.id)).text(result.title);
                                var director = $("<p class='card-text'>Director: " + result.director + "</p>");
                                var year = $("<p class='card-text'>Year: " + result.year + "</p>");
                                var rating = $("<p class='card-text'>Rating: " + result.rating + "</p>");

                                cardContent.append(titleLink, year, director);

                                var genresText = "Genres: ";
                                for (var i = 0; i < result.genres.length; i++) {
                                    var genre = result.genres[i];
                                    var genreLink = $('<a>').attr('href', 'singlegenrepage.html?id=' + encodeURIComponent(genre.id)).text(genre.name);
                                    genresText += (i > 0 ? ", " : "") + genreLink.prop('outerHTML');
                                }
                                var genrePara = $("<p class='card-text'>").html(genresText);
                                cardContent.append(genrePara);

                                var starsText = "Stars: ";
                                for (var i = 0; i < result.stars.length; i++) {
                                    var star = result.stars[i];
                                    var starLink = $('<a>').attr('href', 'singlestarpage.html?id=' + encodeURIComponent(star.id)).text(star.name);
                                    starsText += (i > 0 ? ", " : "") + starLink.prop('outerHTML');
                                }
                                var starPara = $("<p class='card-text'>").html(starsText);
                                cardContent.append(starPara, rating);

                                // Add "Add to Cart" button here
                                // Add "Add to Cart" button here
                                var addToCartBtn = $("<button class='btn btn-primary add-to-cart-btn' data-movie-id='" + result.id + "' data-movie-title='" + result.title + "'>Add to Cart</button>");
                                cardContent.append(addToCartBtn);


                                cardBody.append(cardContent);
                                card.append(cardBody);
                                searchResultsContainer.append(card);

                            });
                        }
                    }

                    // Function to get URL parameter
                    function getUrlParameter(name) {
                        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
                        var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
                        var results = regex.exec(location.search);
                        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
                    }

                    // Event listener for sorting option change
                    $('#sort_option, #page_size').change(function () {
                        pageNumber = 1; // Reset page number to 1 when sorting or page size is changed
                        pageSize = parseInt($('#page_size').val());
                        fetchSearchResults(); // Fetch search results with updated parameters

                        // Update URL with parameters
                        updateURL();
                    });

                    // Event listeners for Previous and Next buttons
                    $('#prev_btn').click(function () {
                        if (pageNumber > 1) {
                            pageNumber--;
                            fetchSearchResults(); // Fetch search results with updated page number
                        }

                        // Update URL with parameters
                        updateURL();
                    });

                    $('#next_btn').click(function () {
                        pageNumber++;
                        fetchSearchResults(); // Fetch search results with updated page number

                        // Update URL with parameters
                        updateURL();
                    });

                    // Function to update URL with parameters
                    // Function to update URL with parameters
                    function updateURL() {
                        var newURL = window.location.pathname + '?'; // Get the current URL path

                        // Add search criteria to the new URL
                        newURL += 'title=' + encodeURIComponent(getUrlParameter('title')) + '&';
                        newURL += 'director=' + encodeURIComponent(getUrlParameter('director')) + '&';
                        newURL += 'year=' + encodeURIComponent(getUrlParameter('year')) + '&';
                        newURL += 'star=' + encodeURIComponent(getUrlParameter('star')) + '&';

                        // Add sorting and pagination parameters to the URL
                        newURL += 'sort_option=' + encodeURIComponent($('#sort_option').val()) + '&';
                        newURL += 'page_size=' + encodeURIComponent($('#page_size').val()) + '&';
                        newURL += 'page_number=' + encodeURIComponent(pageNumber);

                        // Update the URL without reloading the page
                        history.pushState({}, '', newURL);

                        // Log the updated URL
                        console.log('Updated URL:', newURL);
                    }


                    // Fetch search results with default parameters and sorting on page load
                    fetchSearchResults();
                });

            } else if (idParam !== '') {
                $(document).ready(function () {
                    var pageNumber = 1; // Initialize page number
                    // Function to fetch movies by genre with sorting and pagination parameters
                    function fetchMoviesByGenre() {
                        var urlParams = new URLSearchParams(window.location.search);
                        var genreId = urlParams.get('id');
                        var sortOption = $('#sort_option').val();
                        var pageSize = $('#page_size').val();
                        // var encodedGenreId = encodeURIComponent(genreId);
                        // var sortOption = $('#sort_option').val();
                        // var pageSize = $('#page_size').val();
                        // var pageNumber = $('#page_number').val() || 1;
                        // var currentPage = pageNumber > 1 ? '&page=' + pageNumber : ''; // Check if page number is greater than 1
                        // var url = 'singlegenrepage?id=' + encodedGenreId + '&sort_option=' + sortOption + '&pageSize=' + pageSize + currentPage;

                        $.ajax({
                            url: 'singlegenrepage?id=' + genreId + '&sort_option=' + sortOption + '&pageSize=' + pageSize + '&pageNumber=' + pageNumber,
                            method: 'GET',
                            dataType: 'json',
                            success: function (movies) {
                                var genreMovies = $('#genreMovies');
                                genreMovies.empty(); // Clear existing movie cards

                                $.each(movies, function (index, movie) {
                                    // Create movie card and append to genreMovies
                                    var col = $('<div class="col-md-4 mb-4">');
                                    var card = $('<div class="card">');
                                    var cardBody = $('<div class="card-body">');
                                    var titleLink = $('<a>').attr('href', 'singlemoviepage.html?id=' + encodeURIComponent(movie.id)).text(movie.title);
                                    var director = $("<p class='card-text'>Director: " + movie.director + "</p>");
                                    var year = $("<p class='card-text'>Year: " + movie.year + "</p>");
                                    var rating = $("<p class='card-text'>Rating: " + movie.rating + "</p>");

                                    cardBody.append(titleLink, director, year);

                                    // Genres
                                    var genresText = "Genres: ";
                                    for (var i = 0; i < movie.genres.length; i++) {
                                        var genre = movie.genres[i];
                                        var genreLink = $('<a>').attr('href', 'singlegenrepage.html?id=' + encodeURIComponent(genre.id)).text(genre.name);
                                        genresText += (i > 0 ? ", " : "") + genreLink.prop('outerHTML');
                                    }
                                    var genrePara = $("<p class='card-text'>").html(genresText);
                                    cardBody.append(genrePara);

                                    // Stars
                                    var starsText = "Stars: ";
                                    for (var i = 0; i < movie.stars.length; i++) {
                                        var star = movie.stars[i];
                                        var starLink = $('<a>').attr('href', 'singlestarpage.html?id=' + encodeURIComponent(star.id)).text(star.name);
                                        starsText += (i > 0 ? ", " : "") + starLink.prop('outerHTML');
                                    }
                                    var starPara = $("<p class='card-text'>").html(starsText);
                                    cardBody.append(starPara, rating);

                                    // Add "Add to Cart" button here
                                    var addToCartBtn = $("<button class='btn btn-primary add-to-cart-btn' data-movie-id='" + movie.id + "' data-movie-title='" + movie.title + "'>Add to Cart</button>");
                                    cardBody.append(addToCartBtn);

                                    card.append(cardBody);
                                    col.append(card);
                                    genreMovies.append(col);
                                });
                            },
                            error: function (xhr, status, error) {
                                console.error('Error fetching movies by genre:', status, error);
                                alert('Failed to fetch movies by genre. Please try again later.');
                            }
                        });
                    }

                    // Event listeners for sorting options, page size, and page number
                    $('#sort_option, #page_size').change(function () {
                        pageNumber = 1; // Reset page number to 1 when sorting or page size is changed
                        fetchMoviesByGenre(); // Fetch movies with selected parameters

                    });

                    $('#prev_btn').click(function () {
                        if (pageNumber > 1) {
                            pageNumber--;
                            fetchMoviesByGenre(); // Fetch movies with updated page number
                        }
                    });

                    $('#next_btn').click(function () {
                        pageNumber++;
                        fetchMoviesByGenre(); // Fetch movies with updated page number
                    });

                    // Fetch movies by genre with default parameters on page load
                    fetchMoviesByGenre();
                });


            } else if (characParam !== '') {
                // Script for charac parameter
                $(document).ready(function () {
                    var pageNumber = 1; // Initialize page number
                    var pageSize = 10; // Default page size

                    // Function to fetch movies by character with sorting and pagination parameters
                    function fetchMoviesByCharacter() {
                        var character = getUrlParameter('charac');
                        var sortOption = $('#sort_option').val();
                        $.ajax({
                            url: 'moviesbyalphanum',
                            method: 'GET',
                            data: {
                                charac: character,
                                sort_option: sortOption,
                                pageSize: pageSize,
                                pageNumber: pageNumber
                            },
                            dataType: 'json',
                            success: function (movies) {
                                displayMovies(movies);
                            },
                            error: function (xhr, status, error) {
                                console.error('Error fetching movies by character:', status, error);
                                alert('Failed to fetch movies by character. Please try again later.');
                            }
                        });
                    }

                    // Function to display movies
                    function displayMovies(movies) {
                        var movieList = $('#genreMovies');
                        movieList.empty(); // Clear existing movie list

                        if (movies.length === 0) {
                            movieList.html("<p class='text-muted'>No movies found for the character '" + getUrlParameter('charac').toUpperCase() + "'</p>");
                        } else {
                            var row = $('<div class="row"></div>');

                            $.each(movies, function (index, movie) {
                                var col = $('<div class="col-md-4 mb-4"></div>');
                                var card = $('<div class="card"></div>');
                                var cardBody = $('<div class="card-body"></div>');
                                var title = $('<h5 class="card-title"></h5>').html("<a href='singlemoviepage.html?id=" + movie.id + "'>" + movie.title + "</a>");
                                var director = $('<p class="card-text">Director: ' + movie.director + '</p>');
                                var year = $('<p class="card-text">Year: ' + movie.year + '</p>');
                                var rating = $('<p class="card-text">Rating: ' + movie.rating + '</p>');

                                cardBody.append(title, director, year);

                                // Genres
                                var genresText = "Genres: ";
                                for (var i = 0; i < movie.genres.length; i++) {
                                    var genre = movie.genres[i];
                                    var genreLink = $('<a>').attr('href', 'singlegenrepage.html?id=' + encodeURIComponent(genre.id)).text(genre.name);
                                    genresText += (i > 0 ? ", " : "") + genreLink.prop('outerHTML');
                                }
                                var genrePara = $("<p class='card-text'>").html(genresText);
                                cardBody.append(genrePara);

                                // Stars
                                var starsText = "Stars: ";
                                for (var i = 0; i < movie.stars.length; i++) {
                                    var star = movie.stars[i];
                                    var starLink = $('<a>').attr('href', 'singlestarpage.html?id=' + encodeURIComponent(star.id)).text(star.name);
                                    starsText += (i > 0 ? ", " : "") + starLink.prop('outerHTML');
                                }
                                var starPara = $("<p class='card-text'>").html(starsText);
                                cardBody.append(starPara, rating);

                                // Add "Add to Cart" button here
                                var addToCartBtn = $("<button class='btn btn-primary add-to-cart-btn' data-movie-id='" + movie.id + "' data-movie-title='" + movie.title + "'>Add to Cart</button>");
                                cardBody.append(addToCartBtn);

                                card.append(cardBody);
                                col.append(card);
                                row.append(col);

                            });

                            movieList.append(row);
                        }
                    }

                    // Function to get URL parameter
                    function getUrlParameter(name) {
                        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
                        var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
                        var results = regex.exec(location.search);
                        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
                    }

                    // Event listeners for sorting option and page size
                    $('#sort_option, #page_size').change(function () {
                        pageNumber = 1; // Reset page number to 1 when sorting or page size is changed
                        pageSize = parseInt($('#page_size').val());
                        fetchMoviesByCharacter(); // Fetch movies with selected parameters
                    });

                    // Event listeners for Previous and Next buttons
                    $('#prev_btn').click(function () {
                        if (pageNumber > 1) {
                            pageNumber--;
                            fetchMoviesByCharacter(); // Fetch movies with updated page number
                        }
                    });

                    $('#next_btn').click(function () {
                        pageNumber++;
                        fetchMoviesByCharacter(); // Fetch movies with updated page number
                    });

                    // Fetch movies by character with default parameters on page load
                    fetchMoviesByCharacter();
                });
            }
        });

        $(document).ready(function () {
            // Enable/disable back button based on URL parameters
            var urlParams = new URLSearchParams(window.location.search);
            var genreId = urlParams.get('id');

            if (genreId) {
                $('#backToMovieListBtn').removeAttr('disabled');
            }

            // Event listener for back button click
            $('#backToMovieListBtn').click(function () {
                // Navigate back to Movie List Page
                window.location.href = 'moviespage.html?id=' + encodeURIComponent(genreId);
            });
        });
    </script>
</body>

</html>